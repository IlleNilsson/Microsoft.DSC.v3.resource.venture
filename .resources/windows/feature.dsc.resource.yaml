# feature.dsc.resource.yaml
$schema:  https://aka.ms/dsc/schemas/v3/bundled/resource/manifest.vscode.json
version: 0.1.0
type: Visity.DSC.Windows/Feature
kind: resource
description: Windows OS Edition agnostic feature handling (WindowsFeature for Server & WindowsOptionalFeature for Clients)
tags:
  - os
  - windows
  - client
  - server
  - agnostic
  - feature
  - optional

get:
  executable: pwsh
  args:
    - -NoLogo
    - -NonInteractive
    - -NoProfile
    - -NoProfileLoadTime
    - -CommandWithArgs
    - |
      #Requires -Version 7.5
      #Requires -PSEdition Core
      #Requires -RunAsAdministrator

      $osType = (Get-CimInstance -ClassName Win32_OperatingSystem).ProductType
      $feature = switch ($osType) {
          1       { Get-WindowsOptionalFeature -Online -FeatureName $name }
          default { Get-WindowsFeature -Name $name }  
      }

      if (!$feature) { 
          throw New-Object ArgumentException "Feature '$name' not found"
      }

      return $feature | ConvertTo-Yaml
  input: stdin
  return: state

test:
  executable: pwsh
  args:
    - -NoLogo
    - -NonInteractive
    - -NoProfile
    - -NoProfileLoadTime
    - -CommandWithArgs
    - |
      #Requires -Version 7.5
      #Requires -PSEdition Core
      #Requires -RunAsAdministrator

      $vars = Get-Variable

      $vars

      return $vars | ConvertTo-Json
  input: stdin
  return: state

set:
  executable: pwsh
  args:
    - -NoLogo
    - -NonInteractive
    - -NoProfile
    - -NoProfileLoadTime
    - -CommandWithArgs
    - |
      #Requires -Version 7.5
      #Requires -PSEdition Core
      #Requires -RunAsAdministrator

      $vars = Get-Variable

      $vars

      return $vars | ConvertTo-Json
  implementsPretest: false
  input: stdin
  return: state

schema:
  embedded:
    $id: file://visity.dsc.windows/feature
    $schema: https://json-schema.org/draft/2020-12/schema
    type: object
    title: Windows Feature's status
    description: Returns information about a Windows Feature's status, is it Enabled or Disabled

    properties:
      name:
        type: 
          $ref: "#/$defs/nonEmptyString"
        title: Feature Name
        description: The name of the Windows Feature
      ensure:
        type: 
          $ref: "#/$defs/ensure"
        title: Feature Enabled or Disabled
        description: Desired Windows Feature state, Enabled or Disabled

    $defs:
      nonEmptyString:
        type: string
        minLength: 1
      ensure:
        type: string
        enum:
          - enabled
          - disabled

    required:
      - name
      - ensure
      
exitCodes:
  0: Success
  1: Failure
